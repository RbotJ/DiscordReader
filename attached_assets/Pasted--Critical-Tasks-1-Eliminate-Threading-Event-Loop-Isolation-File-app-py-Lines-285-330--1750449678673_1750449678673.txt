ğŸš¨ Critical Tasks
1. ğŸ”¥ Eliminate Threading + Event Loop Isolation
File: app.py (Lines ~285-330)

âœ… Remove usage of threading.Thread() and asyncio.new_event_loop() for launching:

The Discord bot

The PostgreSQL event listener

ğŸ§  Instead, restructure the app to use a single shared asyncio event loop.

Launch the Discord bot and listener using loop.create_task(...)

Ensure all async tasks share the same DB session context

ğŸ”’ PostgreSQL LISTEN will not deliver messages across threads with isolated event loops â€” this must be unified.

2. âŒ Remove All Legacy Imports and Calls to publish_cross_slice_event
âœ… Delete these broken references:

features/discord_bot/services/message_relay.py:12 â†’ remove from common.events.bus import publish_cross_slice_event

features/ingestion/service.py:235, 264 â†’ replace with:

python
Copy
Edit
from common.events.publisher import publish_event
await publish_event("event_name", {"your": "payload"})
ğŸ§¹ Search entire codebase for any remaining calls to publish_cross_slice_event() or imports from common.events.bus and remove them.

3. ğŸ§­ Standardize Event Publishing System
âœ… Use only:

python
Copy
Edit
from common.events.publisher import publish_event
ğŸš« Avoid mixing in:

enhanced_publisher.py

any EventPublisher classes with DB-only storage but no real-time NOTIFY

ğŸ”„ If needed, consolidate logic from enhanced_publisher.py into publisher.py and delete the former to reduce ambiguity.

4. ğŸš« Fix PostgreSQL Listener Isolation
File: features/ingestion/listener.py

âœ… Confirm this module calls:

python
Copy
Edit
from common.events.publisher import listen_for_events
ğŸš« Do NOT start it in a thread with its own event loop

ğŸ” Start it from app.py using loop.create_task(...) in the main Flask app context

âœ… Final Acceptance Criteria
Checkpoint	Criteria
âœ… Single Loop Architecture	No new threads or isolated event loops in app.py
âœ… Unified Publisher Module	All events use common.events.publisher.publish_event()
âœ… Legacy Bus Removed	No publish_cross_slice_event or common.events.bus references
âœ… Listener Uses Shared Connection	listen_for_events() runs in main app event loop, not isolated thread
âœ… Logging for Debugging	Event publishing and listening is clearly logged at INFO level

Let me know once these items are complete, and I will validate via Discord message event flow and database persistence.