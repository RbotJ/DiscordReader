Use the following exact prompt to complete the migration to PostgreSQL-based events and eliminate legacy patterns:

âœ… Replit Agent Prompt: Finalize PostgreSQL Event System Migration
ğŸ¯ Objective:
Eliminate remaining non-compliant event logic and enforce full PostgreSQL LISTEN/NOTIFY consistency across all publishers and listeners.

ğŸ”§ Tasks to Complete
ğŸ” 1. Replace Legacy Event Publisher in Discord Bot
ğŸ“ File: features/discord_bot/service.py (Lines 80â€“90)

ğŸ”¥ Issue: Calls publish_cross_slice_event, which is now undefined and obsolete.

âœ… Fix: Replace with:

python
Copy
Edit
from common.events.publisher import publish_event_async

await publish_event_async("discord.message.new", {"channel_id": channel.id, "message_id": message.id})
ğŸ§¼ Clean up any leftover imports or references to publish_cross_slice_event.

ğŸ” 2. Fix Parsing Listener to Use PostgreSQL Events
ğŸ“ File: features/parsing/listener.py (Lines 45â€“55)

ğŸ”¥ Issue: Calls consumer.subscribe() which implies in-memory subscription.

âœ… Fix: Replace with PostgreSQL-based listener:

python
Copy
Edit
from common.events.publisher import listen_for_events
from .parser import parse_setup_message

async def handle_event(event_type, payload):
    if event_type == "MESSAGE_STORED":
        await parse_setup_message(payload["message_id"])

def start_listening():
    import asyncio
    loop = asyncio.get_event_loop()
    loop.create_task(listen_for_events(handle_event))
ğŸ“Œ Ensure start_listening() is registered once during app.py startup, using the same unified async loop.

ğŸ§ª 3. Verify Unified Async Context
ğŸ“ File: app.py (Lines 90â€“120)

ğŸ”„ Status: Partially refactored. Check:

Are start_listening() functions from all slices registered in the same event loop?

Are there any remaining Thread(target=...) or isolated event loops (asyncio.run(...))?

âœ… Fix: Use a single asyncio.get_event_loop() instance for all listener registration.

ğŸ” 4. Add Logging to Event Handlers
âœ… In every publish_event and listen_for_events function:

Add:

python
Copy
Edit
logger.info("ğŸ“¢ Published event: %s", event_type)
logger.info("ğŸ“¥ Received event: %s", event_type)
ğŸš« Do not suppress exceptions in event publishing. If publish_event_async fails, log the full exception.

ğŸ§¹ Cleanup Tasks
âœ… Remove common/events/bus.py if still present.

âœ… Ensure publish_cross_slice_event() no longer exists anywhere.

âœ… Add comment in publisher.py explaining:

"This is the only approved mechanism for cross-slice events. All components must use publish_event() or listen_for_events() from this file."