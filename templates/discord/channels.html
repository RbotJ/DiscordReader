{% extends "base.html" %}
{% block title %}Discord Channel Management - A+ Trading{% endblock %}

{% block content %}
        <div class="row">
            <div class="col-12">
                <h1><i class="fas fa-cogs"></i> Discord Channel Management</h1>
                <p class="text-muted">Configure which Discord channels to monitor for trading setups and where to send announcements.</p>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <h5 class="card-title">Total Channels</h5>
                        <h3 id="total-channels">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <h5 class="card-title">Listening</h5>
                        <h3 id="listening-channels">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body">
                        <h5 class="card-title">Announcing</h5>
                        <h3 id="announce-channels">-</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <h5 class="card-title">Active</h5>
                        <h3 id="active-channels">-</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Channels Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Discord Channels</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="channels-table">
                                <thead>
                                    <tr>
                                        <th>Channel Name</th>
                                        <th>Type</th>
                                        <th>Status</th>
                                        <th>Listen</th>
                                        <th>Announce</th>
                                        <th>Last Seen</th>
                                    </tr>
                                </thead>
                                <tbody id="channels-tbody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

{% endblock %}

{% block extra_js %}
    <script>
        // Load channels data
        async function loadChannels() {
            try {
                const response = await fetch('/admin/discord/api/channels');
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayChannels(data.channels);
                    updateStats(data.channels);
                } else {
                    showError('Failed to load channels: ' + data.message);
                }
            } catch (error) {
                showError('Error loading channels: ' + error.message);
            }
        }

        function displayChannels(channels) {
            const tbody = document.getElementById('channels-tbody');
            tbody.innerHTML = '';

            channels.forEach(channel => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <i class="fas fa-hashtag"></i> ${channel.name}
                        <br><small class="text-muted">ID: ${channel.channel_id}</small>
                    </td>
                    <td><span class="badge bg-secondary">${channel.channel_type}</span></td>
                    <td>
                        ${channel.is_active ? 
                            '<span class="badge bg-success">Active</span>' : 
                            '<span class="badge bg-danger">Inactive</span>'
                        }
                    </td>
                    <td>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" 
                                   id="listen-${channel.id}" 
                                   ${channel.is_listen ? 'checked' : ''}
                                   onchange="updateChannelConfig('${channel.channel_id}', 'listen', this.checked)">
                        </div>
                    </td>
                    <td>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" 
                                   id="announce-${channel.id}" 
                                   ${channel.is_announce ? 'checked' : ''}
                                   onchange="updateChannelConfig('${channel.channel_id}', 'announce', this.checked)">
                        </div>
                    </td>
                    <td>
                        ${channel.last_seen ? 
                            new Date(channel.last_seen).toLocaleString() : 
                            'Never'
                        }
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateStats(channels) {
            document.getElementById('total-channels').textContent = channels.length;
            document.getElementById('listening-channels').textContent = 
                channels.filter(c => c.is_listen).length;
            document.getElementById('announce-channels').textContent = 
                channels.filter(c => c.is_announce).length;
            document.getElementById('active-channels').textContent = 
                channels.filter(c => c.is_active).length;
        }

        async function updateChannelConfig(channelId, type, enabled) {
            try {
                const response = await fetch('/admin/discord/api/channels/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        channel_id: channelId,
                        type: type,
                        enabled: enabled
                    })
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    showSuccess(`Channel ${type} setting updated successfully`);
                    loadChannels();
                } else {
                    showError('Failed to update channel: ' + data.message);
                    location.reload();
                }
            } catch (error) {
                showError('Error updating channel: ' + error.message);
                location.reload();
            }
        }

        function showSuccess(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.row'));
            setTimeout(() => alert.remove(), 3000);
        }

        function showError(message) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.row'));
        }

        document.addEventListener('DOMContentLoaded', loadChannels);
    </script>
{% endblock %}