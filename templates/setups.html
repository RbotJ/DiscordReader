{% extends "base.html" %}

{% block title %}Trading Setups - A+ Trading{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Trading Setups</h5>
                <div>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSetupModal">
                        <i class="fas fa-plus me-1"></i> Add Setup
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="setup-filters mb-3">
                    <div class="input-group">
                        <input type="text" id="setup-search" class="form-control" placeholder="Search setups...">
                        <button class="btn btn-outline-secondary" type="button" id="clear-search">Clear</button>
                    </div>
                </div>
                
                <div class="setup-list" id="setup-list">
                    {% if setups %}
                        {% for setup_message in setups %}
                            <div class="setup-card">
                                <div class="setup-header">
                                    <div class="setup-date">{{ setup_message.date }}</div>
                                    <div class="setup-count">{{ setup_message.setups|length }} ticker{% if setup_message.setups|length != 1 %}s{% endif %}</div>
                                </div>
                                <div class="setup-tickers">
                                    {% for ticker_setup in setup_message.setups %}
                                        <div class="setup-ticker-item">
                                            <span class="ticker-symbol">{{ ticker_setup.symbol }}</span>
                                            <div class="ticker-signals">
                                                {% for signal in ticker_setup.signals %}
                                                    <span class="badge signal-badge signal-{{ signal.category }}">
                                                        {{ signal.category }} {{ signal.comparison }} {{ signal.trigger }}
                                                    </span>
                                                {% endfor %}
                                            </div>
                                            {% if ticker_setup.bias %}
                                                <div class="ticker-bias">
                                                    <span class="badge bias-badge bias-{{ ticker_setup.bias.direction }}">
                                                        {{ ticker_setup.bias.direction }} {{ ticker_setup.bias.condition }} {{ ticker_setup.bias.price }}
                                                    </span>
                                                </div>
                                            {% endif %}
                                            <div class="ticker-actions">
                                                <button class="btn btn-sm btn-outline-primary view-setup-btn" 
                                                        data-setup="{{ ticker_setup.symbol }}"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#viewSetupModal">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-success trigger-setup-btn"
                                                        data-setup="{{ ticker_setup.symbol }}">
                                                    <i class="fas fa-bolt"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="setup-raw-toggle" data-bs-toggle="collapse" data-bs-target="#raw-{{ loop.index }}">
                                    <i class="fas fa-code me-1"></i> Show Raw Message
                                </div>
                                <div class="collapse setup-raw" id="raw-{{ loop.index }}">
                                    <pre>{{ setup_message.raw_text }}</pre>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center p-5">
                            <div class="mb-3">
                                <i class="fas fa-chart-line fa-3x text-muted"></i>
                            </div>
                            <h5>No setups found</h5>
                            <p class="text-muted">Add your first setup by pasting an A+ Trading setup message.</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addSetupModal">
                                Add Setup
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Setup Parser</h5>
            </div>
            <div class="card-body">
                <form id="setup-parser-form">
                    <div class="mb-3">
                        <label for="setup-message" class="form-label">Enter A+ Setup Message</label>
                        <textarea class="form-control" id="setup-message" rows="8" placeholder="Paste the setup message here..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Parse Setup</button>
                </form>
                <div id="parser-result" class="mt-3"></div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Setup Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row stats-row">
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-label">Total Setups</div>
                            <div class="stat-value" id="total-setups">{{ setups|length }}</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-label">Total Tickers</div>
                            <div class="stat-value" id="total-tickers">
                                {% set ticker_count = 0 %}
                                {% for setup_message in setups %}
                                    {% set ticker_count = ticker_count + setup_message.setups|length %}
                                {% endfor %}
                                {{ ticker_count }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row stats-row">
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-label">Breakouts</div>
                            <div class="stat-value" id="breakout-count">-</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-label">Breakdowns</div>
                            <div class="stat-value" id="breakdown-count">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="row stats-row">
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-label">Triggered</div>
                            <div class="stat-value" id="triggered-count">-</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="stat-item">
                            <div class="stat-label">Success Rate</div>
                            <div class="stat-value" id="success-rate">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Setup Modal -->
<div class="modal fade" id="addSetupModal" tabindex="-1" aria-labelledby="addSetupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSetupModalLabel">Add New Setup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="setupTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="message-tab" data-bs-toggle="tab" data-bs-target="#message-tab-pane" type="button" role="tab" aria-controls="message-tab-pane" aria-selected="true">Setup Message</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-tab-pane" type="button" role="tab" aria-controls="manual-tab-pane" aria-selected="false">Manual Entry</button>
                    </li>
                </ul>
                
                <div class="tab-content" id="setupTabsContent">
                    <div class="tab-pane fade show active p-3" id="message-tab-pane" role="tabpanel" aria-labelledby="message-tab" tabindex="0">
                        <form id="setup-message-form">
                            <div class="mb-3">
                                <label for="setup-message-input" class="form-label">A+ Setup Message</label>
                                <textarea class="form-control" id="setup-message-input" rows="10" placeholder="Paste the A+ setup message here..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Parse & Add</button>
                        </form>
                    </div>
                    
                    <div class="tab-pane fade p-3" id="manual-tab-pane" role="tabpanel" aria-labelledby="manual-tab" tabindex="0">
                        <form id="manual-setup-form">
                            <div class="mb-3">
                                <label for="manual-symbol" class="form-label">Symbol</label>
                                <input type="text" class="form-control" id="manual-symbol" required placeholder="e.g., AAPL">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Signal</label>
                                <div class="signal-builder">
                                    <div class="row g-2 mb-2">
                                        <div class="col-md-3">
                                            <select class="form-select" id="signal-category">
                                                <option value="breakout">Breakout</option>
                                                <option value="breakdown">Breakdown</option>
                                                <option value="rejection">Rejection</option>
                                                <option value="bounce">Bounce</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" id="signal-comparison">
                                                <option value="above">Above</option>
                                                <option value="below">Below</option>
                                                <option value="near">Near</option>
                                                <option value="range">Range</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" class="form-control" id="signal-trigger" step="0.01" placeholder="Trigger price">
                                        </div>
                                        <div class="col-md-2">
                                            <button type="button" id="add-signal-btn" class="btn btn-sm btn-outline-primary w-100">Add</button>
                                        </div>
                                    </div>
                                    <div id="signal-list" class="mb-2"></div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Targets</label>
                                <div class="row g-2">
                                    <div class="col-md-5">
                                        <input type="number" class="form-control" id="target-price" step="0.01" placeholder="Target price">
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" id="add-target-btn" class="btn btn-sm btn-outline-primary w-100">Add</button>
                                    </div>
                                    <div class="col-md-5" id="targets-list">
                                        <!-- Targets will appear here -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="has-bias-switch">
                                    <label class="form-check-label" for="has-bias-switch">Add Bias</label>
                                </div>
                            </div>
                            
                            <div id="bias-container" class="mb-3" style="display: none;">
                                <div class="row g-2">
                                    <div class="col-md-4">
                                        <select class="form-select" id="bias-direction">
                                            <option value="bullish">Bullish</option>
                                            <option value="bearish">Bearish</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <select class="form-select" id="bias-condition">
                                            <option value="above">Above</option>
                                            <option value="below">Below</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="number" class="form-control" id="bias-price" step="0.01" placeholder="Price level">
                                    </div>
                                </div>
                                
                                <div class="mt-2">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="has-flip-switch">
                                        <label class="form-check-label" for="has-flip-switch">Add Bias Flip</label>
                                    </div>
                                </div>
                                
                                <div id="flip-container" class="mt-2" style="display: none;">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <select class="form-select" id="flip-direction">
                                                <option value="bullish">Bullish</option>
                                                <option value="bearish">Bearish</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select" id="flip-condition">
                                                <option value="above">Above</option>
                                                <option value="below">Below</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" class="form-control" id="flip-price" step="0.01" placeholder="Flip price">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Create Setup</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Setup Details Modal -->
<div class="modal fade" id="viewSetupModal" tabindex="-1" aria-labelledby="viewSetupModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewSetupModalLabel">Setup Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="setup-details-container">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="trade-setup-btn">Trade This Setup</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        initSetupPage();
    });
</script>
{% endblock %}
