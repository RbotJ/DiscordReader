{% extends "base.html" %}

{% block title %}A+ Trading Dashboard{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
<style>
  .card {
    margin-bottom: 1.5rem;
  }
  .status-badge {
    font-size: 0.85rem;
  }
  .status-badge.active {
    background-color: var(--bs-success);
  }
  .status-badge.inactive {
    background-color: var(--bs-danger);
  }
  .notification-list {
    max-height: 300px;
    overflow-y: auto;
  }
  .ticker-price {
    font-weight: bold;
    font-size: 1.2rem;
  }
  .price-up {
    color: var(--bs-success);
  }
  .price-down {
    color: var(--bs-danger);
  }
  .order-status-pill {
    text-transform: capitalize;
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="d-flex justify-content-between align-items-center">
        <h1>A+ Trading Dashboard</h1>
        <div>
          <span id="market-status" class="badge bg-secondary me-2">Market Status: Unknown</span>
          <span id="strategy-status" class="badge status-badge inactive">Strategy: Inactive</span>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Account Information -->
    <div class="col-md-4">
      <div class="card bg-dark">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Account</h5>
          <button id="refresh-account" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
        <div class="card-body">
          <div id="account-info">
            <div class="text-center py-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading account information...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Watchlist -->
    <div class="col-md-4">
      <div class="card bg-dark">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Watchlist</h5>
          <div>
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addWatchlistModal">
              <i class="bi bi-plus"></i> Add
            </button>
            <button id="refresh-watchlist" class="btn btn-sm btn-outline-primary ms-2">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="watchlist">
            <div class="text-center py-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading watchlist...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Active Signals -->
    <div class="col-md-4">
      <div class="card bg-dark">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Active Signals</h5>
          <div>
            <button id="toggle-strategy" class="btn btn-sm btn-outline-primary me-2">Start Strategy</button>
            <button id="refresh-signals" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="active-signals">
            <div class="text-center py-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading active signals...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <!-- Open Positions -->
    <div class="col-md-6">
      <div class="card bg-dark">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Open Positions</h5>
          <button id="refresh-positions" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
        <div class="card-body">
          <div id="positions">
            <div class="text-center py-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading positions...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Orders -->
    <div class="col-md-6">
      <div class="card bg-dark">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Recent Orders</h5>
          <div>
            <button type="button" class="btn btn-sm btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#placeOrderModal">
              <i class="bi bi-plus"></i> Place Order
            </button>
            <button id="refresh-orders" class="btn btn-sm btn-outline-primary">
              <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="orders">
            <div class="text-center py-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading orders...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <!-- Notifications -->
    <div class="col-md-12">
      <div class="card bg-dark">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">Recent Notifications</h5>
          <button id="refresh-notifications" class="btn btn-sm btn-outline-primary">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
        <div class="card-body">
          <div id="notifications" class="notification-list">
            <div class="text-center py-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading notifications...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add to Watchlist Modal -->
<div class="modal fade" id="addWatchlistModal" tabindex="-1" aria-labelledby="addWatchlistModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark">
      <div class="modal-header">
        <h5 class="modal-title" id="addWatchlistModalLabel">Add to Watchlist</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="watchlist-symbol" class="form-label">Symbol</label>
          <input type="text" class="form-control" id="watchlist-symbol" placeholder="e.g., AAPL, SPY" required>
          <div class="form-text">Enter one or more symbols separated by commas</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="add-to-watchlist">Add</button>
      </div>
    </div>
  </div>
</div>

<!-- Place Order Modal -->
<div class="modal fade" id="placeOrderModal" tabindex="-1" aria-labelledby="placeOrderModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark">
      <div class="modal-header">
        <h5 class="modal-title" id="placeOrderModalLabel">Place Order</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="order-form">
          <div class="mb-3">
            <label for="order-symbol" class="form-label">Symbol</label>
            <input type="text" class="form-control" id="order-symbol" placeholder="e.g., AAPL" required>
          </div>
          <div class="mb-3">
            <label for="order-type" class="form-label">Order Type</label>
            <select class="form-select" id="order-type" required>
              <option value="market">Market</option>
              <option value="limit">Limit</option>
              <option value="stop">Stop</option>
            </select>
          </div>
          <div class="mb-3" id="limit-price-group" style="display: none;">
            <label for="limit-price" class="form-label">Limit Price</label>
            <input type="number" class="form-control" id="limit-price" step="0.01" min="0.01">
          </div>
          <div class="mb-3" id="stop-price-group" style="display: none;">
            <label for="stop-price" class="form-label">Stop Price</label>
            <input type="number" class="form-control" id="stop-price" step="0.01" min="0.01">
          </div>
          <div class="mb-3">
            <label for="order-side" class="form-label">Side</label>
            <select class="form-select" id="order-side" required>
              <option value="buy">Buy</option>
              <option value="sell">Sell</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="order-qty" class="form-label">Quantity</label>
            <input type="number" class="form-control" id="order-qty" min="1" step="1" required>
          </div>
          <div class="mb-3">
            <label for="time-in-force" class="form-label">Time in Force</label>
            <select class="form-select" id="time-in-force">
              <option value="day">Day</option>
              <option value="gtc">Good Till Canceled</option>
            </select>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="extended-hours">
            <label class="form-check-label" for="extended-hours">Extended Hours</label>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="submit-order">Place Order</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  // Page initialization
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize components
    refreshAll();
    setupEventListeners();
    checkServiceStatus();
    
    // Set up refresh intervals
    setInterval(refreshAccount, 60000); // Every minute
    setInterval(refreshPositions, 30000); // Every 30 seconds
    setInterval(refreshWatchlist, 10000); // Every 10 seconds
  });
  
  function refreshAll() {
    refreshAccount();
    refreshWatchlist();
    refreshPositions();
    refreshOrders();
    refreshSignals();
    refreshNotifications();
  }
  
  function setupEventListeners() {
    // Refresh buttons
    document.getElementById('refresh-account').addEventListener('click', refreshAccount);
    document.getElementById('refresh-watchlist').addEventListener('click', refreshWatchlist);
    document.getElementById('refresh-positions').addEventListener('click', refreshPositions);
    document.getElementById('refresh-orders').addEventListener('click', refreshOrders);
    document.getElementById('refresh-signals').addEventListener('click', refreshSignals);
    document.getElementById('refresh-notifications').addEventListener('click', refreshNotifications);
    
    // Strategy toggle
    document.getElementById('toggle-strategy').addEventListener('click', toggleStrategy);
    
    // Add to watchlist
    document.getElementById('add-to-watchlist').addEventListener('click', addToWatchlist);
    
    // Order form
    document.getElementById('order-type').addEventListener('change', toggleOrderPriceFields);
    document.getElementById('submit-order').addEventListener('click', submitOrder);
  }
  
  function checkServiceStatus() {
    // Check market status
    fetch('/api/market/status')
      .then(response => response.json())
      .then(data => {
        const marketStatus = document.getElementById('market-status');
        if (data.status === 'ok') {
          marketStatus.textContent = 'Market Status: Connected';
          marketStatus.classList.remove('bg-secondary', 'bg-danger');
          marketStatus.classList.add('bg-success');
        } else {
          marketStatus.textContent = 'Market Status: Disconnected';
          marketStatus.classList.remove('bg-secondary', 'bg-success');
          marketStatus.classList.add('bg-danger');
        }
      })
      .catch(error => {
        console.error('Error checking market status:', error);
        document.getElementById('market-status').textContent = 'Market Status: Error';
        document.getElementById('market-status').classList.remove('bg-secondary', 'bg-success');
        document.getElementById('market-status').classList.add('bg-danger');
      });
    
    // Check strategy status
    fetch('/api/strategy/status')
      .then(response => response.json())
      .then(data => {
        const strategyStatus = document.getElementById('strategy-status');
        const toggleBtn = document.getElementById('toggle-strategy');
        
        if (data.running) {
          strategyStatus.textContent = 'Strategy: Active';
          strategyStatus.classList.remove('inactive');
          strategyStatus.classList.add('active');
          toggleBtn.textContent = 'Stop Strategy';
          toggleBtn.classList.remove('btn-outline-primary');
          toggleBtn.classList.add('btn-outline-danger');
        } else {
          strategyStatus.textContent = 'Strategy: Inactive';
          strategyStatus.classList.remove('active');
          strategyStatus.classList.add('inactive');
          toggleBtn.textContent = 'Start Strategy';
          toggleBtn.classList.remove('btn-outline-danger');
          toggleBtn.classList.add('btn-outline-primary');
        }
      })
      .catch(error => {
        console.error('Error checking strategy status:', error);
      });
  }
  
  function toggleStrategy() {
    const btn = document.getElementById('toggle-strategy');
    const action = btn.textContent.includes('Start') ? 'start' : 'stop';
    
    fetch('/api/strategy/control', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ action })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        checkServiceStatus();
        refreshSignals();
      }
    })
    .catch(error => {
      console.error('Error toggling strategy:', error);
    });
  }
  
  function refreshAccount() {
    document.getElementById('account-info').innerHTML = `
      <div class="text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading account information...</p>
      </div>
    `;
    
    fetch('/api/execution/account')
      .then(response => response.json())
      .then(data => {
        if (Object.keys(data).length === 0) {
          document.getElementById('account-info').innerHTML = `
            <div class="alert alert-warning">
              No account information available. Check your Alpaca API credentials.
            </div>
          `;
          return;
        }
        
        let html = `
          <div class="mb-3">
            <h3 class="mb-1">$${parseFloat(data.equity).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h3>
            <small class="text-muted">Account Equity</small>
          </div>
          <div class="row">
            <div class="col-6">
              <div class="mb-2">
                <div>$${parseFloat(data.buying_power).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                <small class="text-muted">Buying Power</small>
              </div>
            </div>
            <div class="col-6">
              <div class="mb-2">
                <div>$${parseFloat(data.cash).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                <small class="text-muted">Cash</small>
              </div>
            </div>
          </div>
          <div class="row mt-2">
            <div class="col-6">
              <div>
                <div>$${parseFloat(data.long_market_value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                <small class="text-muted">Long Value</small>
              </div>
            </div>
            <div class="col-6">
              <div>
                <div>$${parseFloat(data.short_market_value).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                <small class="text-muted">Short Value</small>
              </div>
            </div>
          </div>
          <hr>
          <div class="d-flex justify-content-between align-items-center">
            <small class="text-muted">Status</small>
            <div class="badge ${data.status === 'ACTIVE' ? 'bg-success' : 'bg-warning'}">${data.status}</div>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <small class="text-muted">Pattern Day Trader</small>
            <div class="badge ${data.pattern_day_trader ? 'bg-warning' : 'bg-secondary'}">${data.pattern_day_trader ? 'Yes' : 'No'}</div>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-2">
            <small class="text-muted">Day Trades</small>
            <div>${data.day_trade_count} / ${data.daytrade_count_limit}</div>
          </div>
        `;
        
        document.getElementById('account-info').innerHTML = html;
      })
      .catch(error => {
        console.error('Error refreshing account:', error);
        document.getElementById('account-info').innerHTML = `
          <div class="alert alert-danger">
            Error loading account information.
          </div>
        `;
      });
  }
  
  function refreshWatchlist() {
    document.getElementById('watchlist').innerHTML = `
      <div class="text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading watchlist...</p>
      </div>
    `;
    
    fetch('/api/watchlist')
      .then(response => response.json())
      .then(data => {
        if (data.length === 0) {
          document.getElementById('watchlist').innerHTML = `
            <div class="alert alert-info">
              No symbols in watchlist. Add some using the button above.
            </div>
          `;
          return;
        }
        
        let html = '<div class="list-group">';
        
        data.forEach(item => {
          let priceDisplay = 'N/A';
          let priceClass = '';
          
          if (item.price) {
            priceDisplay = `$${parseFloat(item.price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            // Add logic for price up/down when we have previous price data
          }
          
          html += `
            <div class="list-group-item d-flex justify-content-between align-items-center bg-dark">
              <div>
                <strong>${item.symbol}</strong>
              </div>
              <div class="ticker-price ${priceClass}">${priceDisplay}</div>
              <button class="btn btn-sm btn-outline-danger remove-from-watchlist" data-symbol="${item.symbol}">
                <i class="bi bi-x"></i>
              </button>
            </div>
          `;
        });
        
        html += '</div>';
        
        document.getElementById('watchlist').innerHTML = html;
        
        // Add event listeners to remove buttons
        document.querySelectorAll('.remove-from-watchlist').forEach(btn => {
          btn.addEventListener('click', function() {
            removeFromWatchlist(this.getAttribute('data-symbol'));
          });
        });
      })
      .catch(error => {
        console.error('Error refreshing watchlist:', error);
        document.getElementById('watchlist').innerHTML = `
          <div class="alert alert-danger">
            Error loading watchlist.
          </div>
        `;
      });
  }
  
  function addToWatchlist() {
    const symbolInput = document.getElementById('watchlist-symbol');
    const symbols = symbolInput.value.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
    
    if (symbols.length === 0) {
      return;
    }
    
    fetch('/api/watchlist', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ symbols })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('addWatchlistModal'));
        modal.hide();
        
        // Clear input
        symbolInput.value = '';
        
        // Refresh watchlist
        refreshWatchlist();
      }
    })
    .catch(error => {
      console.error('Error adding to watchlist:', error);
    });
  }
  
  function removeFromWatchlist(symbol) {
    fetch('/api/watchlist', {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ symbols: [symbol] })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        refreshWatchlist();
      }
    })
    .catch(error => {
      console.error('Error removing from watchlist:', error);
    });
  }
  
  function refreshPositions() {
    document.getElementById('positions').innerHTML = `
      <div class="text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading positions...</p>
      </div>
    `;
    
    fetch('/api/execution/positions')
      .then(response => response.json())
      .then(data => {
        if (data.length === 0) {
          document.getElementById('positions').innerHTML = `
            <div class="alert alert-info">
              No open positions.
            </div>
          `;
          return;
        }
        
        let html = `
          <div class="table-responsive">
            <table class="table table-dark table-hover">
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Qty</th>
                  <th>Side</th>
                  <th>Avg Price</th>
                  <th>Current</th>
                  <th>P/L</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        data.forEach(position => {
          const pl = parseFloat(position.unrealized_pl);
          const plClass = pl >= 0 ? 'text-success' : 'text-danger';
          
          html += `
            <tr>
              <td>${position.symbol}</td>
              <td>${parseFloat(position.qty).toLocaleString('en-US')}</td>
              <td><span class="badge ${position.side === 'long' ? 'bg-success' : 'bg-danger'}">${position.side}</span></td>
              <td>$${parseFloat(position.avg_entry_price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
              <td>$${parseFloat(position.current_price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
              <td class="${plClass}">$${pl.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${(parseFloat(position.unrealized_plpc) * 100).toFixed(2)}%)</td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
            </table>
          </div>
        `;
        
        document.getElementById('positions').innerHTML = html;
      })
      .catch(error => {
        console.error('Error refreshing positions:', error);
        document.getElementById('positions').innerHTML = `
          <div class="alert alert-danger">
            Error loading positions.
          </div>
        `;
      });
  }
  
  function refreshOrders() {
    document.getElementById('orders').innerHTML = `
      <div class="text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading orders...</p>
      </div>
    `;
    
    fetch('/api/execution/orders')
      .then(response => response.json())
      .then(data => {
        if (data.length === 0) {
          document.getElementById('orders').innerHTML = `
            <div class="alert alert-info">
              No recent orders.
            </div>
          `;
          return;
        }
        
        // Sort orders by created_at (newest first)
        data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        
        // Take only the 5 most recent orders
        const recentOrders = data.slice(0, 5);
        
        let html = `
          <div class="table-responsive">
            <table class="table table-dark table-hover">
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Side</th>
                  <th>Type</th>
                  <th>Qty</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        recentOrders.forEach(order => {
          let statusClass = '';
          switch (order.status) {
            case 'filled':
              statusClass = 'bg-success';
              break;
            case 'canceled':
            case 'rejected':
              statusClass = 'bg-danger';
              break;
            case 'new':
            case 'accepted':
            case 'pending_new':
              statusClass = 'bg-primary';
              break;
            case 'partially_filled':
              statusClass = 'bg-info';
              break;
            default:
              statusClass = 'bg-secondary';
          }
          
          html += `
            <tr>
              <td>${order.symbol}</td>
              <td>${order.side}</td>
              <td>${order.order_type}</td>
              <td>${order.qty}${order.filled_qty ? ` (${order.filled_qty} filled)` : ''}</td>
              <td><span class="badge order-status-pill ${statusClass}">${order.status}</span></td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
            </table>
          </div>
        `;
        
        document.getElementById('orders').innerHTML = html;
      })
      .catch(error => {
        console.error('Error refreshing orders:', error);
        document.getElementById('orders').innerHTML = `
          <div class="alert alert-danger">
            Error loading orders.
          </div>
        `;
      });
  }
  
  function refreshSignals() {
    document.getElementById('active-signals').innerHTML = `
      <div class="text-center py-3">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading active signals...</p>
      </div>
    `;
    
    fetch('/api/strategy/triggers')
      .then(response => response.json())
      .then(data => {
        if (data.length === 0) {
          document.getElementById('active-signals').innerHTML = `
            <div class="alert alert-info">
              No active signals. Add setups or generate triggers.
            </div>
            <div class="d-grid gap-2">
              <button class="btn btn-outline-primary btn-sm" id="generate-triggers">Generate Triggers</button>
            </div>
          `;
          
          document.getElementById('generate-triggers').addEventListener('click', generateTriggers);
          return;
        }
        
        let html = '<ul class="list-group">';
        
        data.forEach(trigger => {
          let categoryBadge = '';
          
          switch (trigger.category) {
            case 'breakout':
              categoryBadge = '<span class="badge bg-success me-1">Breakout</span>';
              break;
            case 'breakdown':
              categoryBadge = '<span class="badge bg-danger me-1">Breakdown</span>';
              break;
            case 'rejection':
              categoryBadge = '<span class="badge bg-warning me-1">Rejection</span>';
              break;
            case 'bounce':
              categoryBadge = '<span class="badge bg-info me-1">Bounce</span>';
              break;
            default:
              categoryBadge = `<span class="badge bg-secondary me-1">${trigger.category}</span>`;
          }
          
          let comparisonText = '';
          if (trigger.comparison === 'above') {
            comparisonText = `Above ${trigger.trigger_value}`;
          } else if (trigger.comparison === 'below') {
            comparisonText = `Below ${trigger.trigger_value}`;
          } else if (trigger.comparison === 'near') {
            comparisonText = `Near ${trigger.trigger_value}`;
          } else if (trigger.comparison === 'range') {
            comparisonText = `Range ${trigger.trigger_value[0]} - ${trigger.trigger_value[1]}`;
          }
          
          html += `
            <div class="list-group-item bg-dark">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-1">${trigger.symbol}</h5>
                <div>
                  ${categoryBadge}
                  <span class="badge bg-secondary">${trigger.aggressiveness}</span>
                </div>
              </div>
              <p class="mb-1">${comparisonText}</p>
              <div class="d-flex justify-content-between align-items-center">
                <small>ID: ${trigger.id}</small>
                <div>
                  <button class="btn btn-sm btn-outline-primary me-1 execute-signal" data-signal-id="${trigger.signal_id}">Execute</button>
                  <button class="btn btn-sm btn-outline-danger delete-trigger" data-trigger-id="${trigger.id}">Delete</button>
                </div>
              </div>
            </div>
          `;
        });
        
        html += '</ul>';
        
        document.getElementById('active-signals').innerHTML = html;
        
        // Add event listeners to buttons
        document.querySelectorAll('.execute-signal').forEach(btn => {
          btn.addEventListener('click', function() {
            executeSignalTrade(this.getAttribute('data-signal-id'));
          });
        });
        
        document.querySelectorAll('.delete-trigger').forEach(btn => {
          btn.addEventListener('click', function() {
            deleteTrigger(this.getAttribute('data-trigger-id'));
          });
        });
      })
      .catch(error => {
        console.error('Error refreshing signals:', error);
        document.getElementById('active-signals').innerHTML = `
          <div class="alert alert-danger">
            Error loading active signals.
          </div>
        `;
      });
  }
  
  function generateTriggers() {
    fetch('/api/strategy/generate', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        refreshSignals();
      }
    })
    .catch(error => {
      console.error('Error generating triggers:', error);
    });
  }
  
  function executeSignalTrade(signalId) {
    if (!confirm('Are you sure you want to execute this signal?')) {
      return;
    }
    
    fetch('/api/execution/execute', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ signal_id: signalId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert(`Order placed. Order ID: ${data.order_id}`);
        refreshOrders();
      } else {
        alert(`Failed to execute trade: ${data.message}`);
      }
    })
    .catch(error => {
      console.error('Error executing signal trade:', error);
      alert('Error executing trade. See console for details.');
    });
  }
  
  function deleteTrigger(triggerId) {
    if (!confirm('Are you sure you want to delete this trigger?')) {
      return;
    }
    
    fetch(`/api/strategy/triggers/${triggerId}`, {
      method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        refreshSignals();
      }
    })
    .catch(error => {
      console.error('Error deleting trigger:', error);
    });
  }
  
  function refreshNotifications() {
    // For now, we'll use a placeholder since we don't have a notifications API yet
    let html = `
      <div class="alert alert-info">
        No notifications available yet. This feature is coming soon.
      </div>
    `;
    
    document.getElementById('notifications').innerHTML = html;
  }
  
  function toggleOrderPriceFields() {
    const orderType = document.getElementById('order-type').value;
    const limitPriceGroup = document.getElementById('limit-price-group');
    const stopPriceGroup = document.getElementById('stop-price-group');
    
    // Hide both by default
    limitPriceGroup.style.display = 'none';
    stopPriceGroup.style.display = 'none';
    
    // Show based on order type
    if (orderType === 'limit') {
      limitPriceGroup.style.display = 'block';
    } else if (orderType === 'stop') {
      stopPriceGroup.style.display = 'block';
    }
  }
  
  function submitOrder() {
    const symbol = document.getElementById('order-symbol').value.trim().toUpperCase();
    const orderType = document.getElementById('order-type').value;
    const side = document.getElementById('order-side').value;
    const qty = parseInt(document.getElementById('order-qty').value);
    const timeInForce = document.getElementById('time-in-force').value;
    const extendedHours = document.getElementById('extended-hours').checked;
    
    if (!symbol || !qty || qty < 1) {
      alert('Please fill out all required fields.');
      return;
    }
    
    const orderData = {
      symbol,
      qty,
      side,
      type: orderType,
      time_in_force: timeInForce,
      extended_hours: extendedHours
    };
    
    // Add price fields based on order type
    if (orderType === 'limit') {
      const limitPrice = parseFloat(document.getElementById('limit-price').value);
      if (!limitPrice || limitPrice <= 0) {
        alert('Please enter a valid limit price.');
        return;
      }
      orderData.limit_price = limitPrice;
    } else if (orderType === 'stop') {
      const stopPrice = parseFloat(document.getElementById('stop-price').value);
      if (!stopPrice || stopPrice <= 0) {
        alert('Please enter a valid stop price.');
        return;
      }
      orderData.stop_price = stopPrice;
    }
    
    fetch('/api/execution/order', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(orderData)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('placeOrderModal'));
        modal.hide();
        
        // Clear form
        document.getElementById('order-form').reset();
        
        // Show success message
        alert(`Order placed successfully. Order ID: ${data.order_id}`);
        
        // Refresh orders
        refreshOrders();
      } else {
        alert(`Failed to place order: ${data.message}`);
      }
    })
    .catch(error => {
      console.error('Error placing order:', error);
      alert('Error placing order. See console for details.');
    });
  }
</script>
{% endblock %}