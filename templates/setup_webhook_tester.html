<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webhook Tester | A+ Trading</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <style>
        .container {
            max-width: 900px;
        }
        .webhook-form {
            margin-top: 20px;
            margin-bottom: 30px;
        }
        pre {
            background-color: var(--bs-dark);
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
        }
        .hidden {
            display: none;
        }
        .copy-btn {
            position: absolute;
            top: 10px;
            right: 10px;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <header class="mb-4">
            <h1>Webhook Tester</h1>
            <p class="lead">Test sending authenticated webhook requests to the A+ Trading setup endpoint.</p>
        </header>

        <div class="alert alert-info">
            <h4 class="alert-heading">How It Works</h4>
            <p>This tool helps you generate the correct authentication headers for webhook requests to the setup endpoint.</p>
            <ol>
                <li>Enter your message in the form below</li>
                <li>Generate the authentication headers</li>
                <li>Use the generated cURL command to test sending the webhook</li>
            </ol>
        </div>

        <div class="webhook-form">
            <form id="webhook-form">
                <div class="mb-3">
                    <label for="webhook-message" class="form-label">Setup Message</label>
                    <textarea class="form-control" id="webhook-message" rows="10" placeholder="Paste the A+ Trade Setup message here..."></textarea>
                </div>
                <div class="mb-3">
                    <label for="webhook-source" class="form-label">Source</label>
                    <select class="form-select" id="webhook-source">
                        <option value="discord">Discord</option>
                        <option value="email">Email</option>
                        <option value="webhook">Generic Webhook</option>
                    </select>
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="button" id="generate-btn" class="btn btn-primary">Generate Headers</button>
                </div>
            </form>
        </div>

        <div class="alert alert-danger hidden" id="error-alert"></div>

        <div class="results-container hidden" id="results-container">
            <h3>Authentication Headers</h3>
            <div class="position-relative">
                <pre id="headers-content"></pre>
                <button class="btn btn-sm btn-outline-secondary copy-btn" id="copy-headers-btn">Copy</button>
            </div>

            <h3 class="mt-4">cURL Command</h3>
            <div class="position-relative">
                <pre id="curl-content"></pre>
                <button class="btn btn-sm btn-outline-secondary copy-btn" id="copy-curl-btn">Copy</button>
            </div>

            <div class="mt-4">
                <button type="button" id="test-btn" class="btn btn-success">Test Webhook</button>
                <div class="alert alert-info mt-3 hidden" id="results-alert"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const generateBtn = document.getElementById('generate-btn');
            const testBtn = document.getElementById('test-btn');
            const webhookMessage = document.getElementById('webhook-message');
            const webhookSource = document.getElementById('webhook-source');
            const errorAlert = document.getElementById('error-alert');
            const resultsContainer = document.getElementById('results-container');
            const headersContent = document.getElementById('headers-content');
            const curlContent = document.getElementById('curl-content');
            const copyHeadersBtn = document.getElementById('copy-headers-btn');
            const copyCurlBtn = document.getElementById('copy-curl-btn');
            const resultsAlert = document.getElementById('results-alert');

            let generatedHeaders = null;
            let generatedCurl = null;

            generateBtn.addEventListener('click', () => {
                const text = webhookMessage.value.trim();
                if (!text) {
                    errorAlert.textContent = 'Please enter a trade setup message';
                    errorAlert.classList.remove('hidden');
                    return;
                }

                // Reset UI
                errorAlert.classList.add('hidden');
                resultsContainer.classList.add('hidden');

                // Generate timestamp (Unix timestamp in seconds)
                const timestamp = Math.floor(Date.now() / 1000).toString();
                
                // Prepare request to generate signature
                fetch('/api/auth/generate-signature', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        source: webhookSource.value,
                        timestamp: timestamp
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        errorAlert.textContent = data.message;
                        errorAlert.classList.remove('hidden');
                        return;
                    }

                    // Format headers for display
                    const headers = {
                        'Content-Type': 'application/json',
                        'X-Timestamp': data.headers['X-Timestamp'],
                        'X-Signature': data.headers['X-Signature']
                    };
                    
                    generatedHeaders = headers;
                    headersContent.textContent = JSON.stringify(headers, null, 2);
                    
                    // Generate curl command
                    const payload = JSON.stringify({
                        text: text,
                        source: webhookSource.value
                    });
                    
                    const curlCmd = `curl -X POST ${window.location.origin}/api/setups/webhook \\
  -H 'Content-Type: application/json' \\
  -H 'X-Timestamp: ${data.headers['X-Timestamp']}' \\
  -H 'X-Signature: ${data.headers['X-Signature']}' \\
  -d '${payload.replace(/'/g, "\\'")}'`;
                    
                    generatedCurl = curlCmd;
                    curlContent.textContent = curlCmd;
                    
                    resultsContainer.classList.remove('hidden');
                })
                .catch(error => {
                    errorAlert.textContent = 'An error occurred: ' + error.message;
                    errorAlert.classList.remove('hidden');
                });
            });

            // Test webhook
            testBtn.addEventListener('click', () => {
                if (!generatedHeaders) return;
                
                const text = webhookMessage.value.trim();
                resultsAlert.innerHTML = '<div class="d-flex align-items-center"><div class="spinner-border spinner-border-sm me-2" role="status"></div><div>Sending webhook request...</div></div>';
                resultsAlert.classList.remove('hidden');

                fetch('/api/setups/webhook', {
                    method: 'POST',
                    headers: generatedHeaders,
                    body: JSON.stringify({
                        text: text,
                        source: webhookSource.value
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'error') {
                        resultsAlert.classList.remove('alert-info', 'alert-success');
                        resultsAlert.classList.add('alert-danger');
                        resultsAlert.textContent = 'Error: ' + data.message;
                    } else {
                        resultsAlert.classList.remove('alert-info', 'alert-danger');
                        resultsAlert.classList.add('alert-success');
                        let resultText = `Setup processed successfully with ID ${data.setup_id}. `;
                        resultText += `Processed ${data.tickers.length} tickers: ${data.tickers.join(', ')}`;
                        
                        if (data.events_published !== undefined) {
                            resultText += data.events_published 
                                ? '. Events were published.' 
                                : '. Note: Events could not be published.';
                        }
                        
                        resultsAlert.textContent = resultText;
                    }
                })
                .catch(error => {
                    resultsAlert.classList.remove('alert-info', 'alert-success');
                    resultsAlert.classList.add('alert-danger');
                    resultsAlert.textContent = 'An error occurred: ' + error.message;
                });
            });

            // Copy buttons
            copyHeadersBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(headersContent.textContent)
                    .then(() => {
                        copyHeadersBtn.textContent = 'Copied!';
                        setTimeout(() => { copyHeadersBtn.textContent = 'Copy'; }, 2000);
                    });
            });

            copyCurlBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(curlContent.textContent)
                    .then(() => {
                        copyCurlBtn.textContent = 'Copied!';
                        setTimeout(() => { copyCurlBtn.textContent = 'Copy'; }, 2000);
                    });
            });
        });
    </script>
</body>
</html>