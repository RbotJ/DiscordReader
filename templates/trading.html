{% extends 'base.html' %}

{% block title %}Trading Dashboard | A+ Trading App{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h2">Trading Dashboard</h1>
            <div>
                <button class="btn btn-sm btn-primary me-2" id="refreshData">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
                <button class="btn btn-sm btn-success" id="processSignals" data-bs-toggle="modal" data-bs-target="#processModal">
                    <i class="bi bi-play-fill"></i> Process Signals
                </button>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Account Summary</h5>
            </div>
            <div class="card-body" id="accountInfo">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Open Positions</h5>
            </div>
            <div class="card-body p-0">
                <div id="positionsContainer">
                    <div class="d-flex justify-content-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Active Trading Signals</h5>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary active" id="viewAll">All</button>
                    <button type="button" class="btn btn-outline-secondary" id="viewBreakout">Breakout</button>
                    <button type="button" class="btn btn-outline-secondary" id="viewBreakdown">Breakdown</button>
                    <button type="button" class="btn btn-outline-secondary" id="viewRejection">Rejection</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="signalsContainer">
                    <div class="d-flex justify-content-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Process Signals Modal -->
<div class="modal fade" id="processModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Process Trading Signals</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="signalLimit" class="form-label">Number of signals to process</label>
                    <input type="number" class="form-control" id="signalLimit" value="3" min="1" max="10">
                </div>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="testMode" checked>
                    <label class="form-check-label" for="testMode">Test Mode (no actual trades)</label>
                </div>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Warning:</strong> Disabling test mode will execute real paper trades on Alpaca.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmProcess">Process Signals</button>
            </div>
        </div>
    </div>
</div>

<!-- Signal Details Modal -->
<div class="modal fade" id="signalModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="signalModalTitle">Signal Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="signalModalBody">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="processSignalBtn">Process Signal</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch initial data
        fetchAccountInfo();
        fetchPositions();
        fetchSignals();
        
        // Set up refresh button
        document.getElementById('refreshData').addEventListener('click', function() {
            fetchAccountInfo();
            fetchPositions();
            fetchSignals();
        });
        
        // Set up signal processing
        document.getElementById('confirmProcess').addEventListener('click', function() {
            const limit = document.getElementById('signalLimit').value;
            const testMode = document.getElementById('testMode').checked;
            
            processSignals(limit, testMode);
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('processModal'));
            modal.hide();
        });
        
        // Set up signal filters
        document.getElementById('viewAll').addEventListener('click', function() {
            setActiveFilter(this);
            filterSignals('all');
        });
        
        document.getElementById('viewBreakout').addEventListener('click', function() {
            setActiveFilter(this);
            filterSignals('breakout');
        });
        
        document.getElementById('viewBreakdown').addEventListener('click', function() {
            setActiveFilter(this);
            filterSignals('breakdown');
        });
        
        document.getElementById('viewRejection').addEventListener('click', function() {
            setActiveFilter(this);
            filterSignals('rejection');
        });
    });
    
    function setActiveFilter(element) {
        // Remove active class from all filters
        document.querySelectorAll('.btn-group .btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Add active class to clicked filter
        element.classList.add('active');
    }
    
    function filterSignals(category) {
        const signalRows = document.querySelectorAll('#signalsTable tr[data-category]');
        
        signalRows.forEach(row => {
            if (category === 'all' || row.getAttribute('data-category') === category) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    function fetchAccountInfo() {
        fetch('/api/v1/trading/account')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayAccountInfo(data.account);
                } else {
                    console.error('Error fetching account info:', data.message);
                    document.getElementById('accountInfo').innerHTML = 
                        `<div class="alert alert-danger">Error: ${data.message}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('accountInfo').innerHTML = 
                    '<div class="alert alert-danger">Error fetching account information</div>';
            });
    }
    
    function displayAccountInfo(account) {
        if (!account) {
            document.getElementById('accountInfo').innerHTML = 
                '<div class="alert alert-warning">No account information available</div>';
            return;
        }
        
        const html = `
            <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Equity
                    <span class="badge bg-primary rounded-pill">$${parseFloat(account.equity).toLocaleString()}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Cash
                    <span class="badge bg-secondary rounded-pill">$${parseFloat(account.cash).toLocaleString()}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Buying Power
                    <span class="badge bg-info rounded-pill">$${parseFloat(account.buying_power).toLocaleString()}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    Status
                    <span class="badge ${account.status === 'ACTIVE' ? 'bg-success' : 'bg-warning'} rounded-pill">${account.status}</span>
                </li>
            </ul>
        `;
        
        document.getElementById('accountInfo').innerHTML = html;
    }
    
    function fetchPositions() {
        fetch('/api/v1/trading/positions')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayPositions(data.positions);
                } else {
                    console.error('Error fetching positions:', data.message);
                    document.getElementById('positionsContainer').innerHTML = 
                        `<div class="alert alert-danger m-3">Error: ${data.message}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('positionsContainer').innerHTML = 
                    '<div class="alert alert-danger m-3">Error fetching positions</div>';
            });
    }
    
    function displayPositions(positions) {
        if (!positions || positions.length === 0) {
            document.getElementById('positionsContainer').innerHTML = 
                '<div class="alert alert-info m-3">No open positions</div>';
            return;
        }
        
        let html = `
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Qty</th>
                            <th>Side</th>
                            <th>Entry</th>
                            <th>Current</th>
                            <th>P/L</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        positions.forEach(position => {
            const plPercent = parseFloat(position.unrealized_plpc) * 100;
            const plClass = plPercent >= 0 ? 'text-success' : 'text-danger';
            
            html += `
                <tr>
                    <td><strong>${position.symbol}</strong></td>
                    <td>${position.qty}</td>
                    <td>${position.side}</td>
                    <td>$${parseFloat(position.avg_entry_price).toFixed(2)}</td>
                    <td>$${parseFloat(position.current_price).toFixed(2)}</td>
                    <td class="${plClass}">
                        $${parseFloat(position.unrealized_pl).toFixed(2)}
                        (${plPercent.toFixed(2)}%)
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        document.getElementById('positionsContainer').innerHTML = html;
    }
    
    function fetchSignals() {
        fetch('/api/v1/trading/signals')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displaySignals(data.signals);
                } else {
                    console.error('Error fetching signals:', data.message);
                    document.getElementById('signalsContainer').innerHTML = 
                        `<div class="alert alert-danger m-3">Error: ${data.message}</div>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('signalsContainer').innerHTML = 
                    '<div class="alert alert-danger m-3">Error fetching signals</div>';
            });
    }
    
    function displaySignals(signals) {
        if (!signals || signals.length === 0) {
            document.getElementById('signalsContainer').innerHTML = 
                '<div class="alert alert-info m-3">No active signals</div>';
            return;
        }
        
        let html = `
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0" id="signalsTable">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Category</th>
                            <th>Comparison</th>
                            <th>Trigger</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        signals.forEach(signal => {
            const createdDate = new Date(signal.created_at).toLocaleString();
            const triggerDisplay = typeof signal.trigger === 'object' ? 
                `${signal.trigger.type}: ${signal.trigger.value || signal.trigger.low + '-' + signal.trigger.high}` : 
                signal.trigger;
            
            html += `
                <tr data-category="${signal.category.toLowerCase()}" data-signal-id="${signal.id}">
                    <td><strong>${signal.symbol}</strong></td>
                    <td>
                        <span class="badge ${getCategoryBadge(signal.category)}">${signal.category}</span>
                    </td>
                    <td>${signal.comparison}</td>
                    <td>${triggerDisplay}</td>
                    <td>${createdDate}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info view-signal-btn" data-bs-toggle="modal" data-bs-target="#signalModal" data-signal-id="${signal.id}">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success process-single-btn" data-signal-id="${signal.id}">
                            <i class="bi bi-play-fill"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        document.getElementById('signalsContainer').innerHTML = html;
        
        // Attach event listeners to the view buttons
        document.querySelectorAll('.view-signal-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const signalId = this.getAttribute('data-signal-id');
                viewSignalDetails(signalId);
            });
        });
        
        // Attach event listeners to the process buttons
        document.querySelectorAll('.process-single-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const signalId = this.getAttribute('data-signal-id');
                processSingleSignal(signalId, true);  // Default to test mode
            });
        });
    }
    
    function getCategoryBadge(category) {
        switch (category.toLowerCase()) {
            case 'breakout':
                return 'bg-success';
            case 'breakdown':
                return 'bg-danger';
            case 'rejection':
                return 'bg-warning';
            case 'bounce':
                return 'bg-info';
            default:
                return 'bg-secondary';
        }
    }
    
    function viewSignalDetails(signalId) {
        // Set the modal title
        document.getElementById('signalModalTitle').innerText = `Signal Details: #${signalId}`;
        
        // Set the loading state
        document.getElementById('signalModalBody').innerHTML = `
            <div class="d-flex justify-content-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        `;
        
        // Set up the process button
        const processBtn = document.getElementById('processSignalBtn');
        processBtn.setAttribute('data-signal-id', signalId);
        processBtn.addEventListener('click', function() {
            const signalId = this.getAttribute('data-signal-id');
            processSingleSignal(signalId, true);  // Default to test mode
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('signalModal'));
            modal.hide();
        });
        
        // Fetch the signal details
        // This would typically be an API call to get more detailed information
        // For now, we'll just display what we have
        const row = document.querySelector(`tr[data-signal-id="${signalId}"]`);
        if (row) {
            const symbol = row.querySelector('td:first-child').innerText;
            const category = row.querySelector('td:nth-child(2)').innerText;
            const comparison = row.querySelector('td:nth-child(3)').innerText;
            const trigger = row.querySelector('td:nth-child(4)').innerText;
            
            document.getElementById('signalModalBody').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h5>${symbol}</h5>
                        <p>
                            <span class="badge ${getCategoryBadge(category)}">${category}</span>
                            <span class="badge bg-secondary">${comparison}</span>
                        </p>
                        <p><strong>Trigger:</strong> ${trigger}</p>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle-fill"></i>
                            Getting latest market data will be available in a future update.
                        </div>
                    </div>
                </div>
                <div class="form-check form-switch mt-3">
                    <input class="form-check-input" type="checkbox" id="modalTestMode" checked>
                    <label class="form-check-label" for="modalTestMode">Test Mode (no actual trades)</label>
                </div>
            `;
        }
    }
    
    function processSignals(limit, testMode) {
        // Show loading state
        const loadingHtml = `
            <div class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
                <div class="card p-4">
                    <div class="d-flex flex-column align-items-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5>Processing Signals...</h5>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', loadingHtml);
        const loadingElement = document.body.lastElementChild;
        
        // Process the signals
        fetch('/api/v1/trading/signals/process/latest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                limit: limit,
                test_mode: testMode
            })
        })
        .then(response => response.json())
        .then(data => {
            // Remove loading state
            document.body.removeChild(loadingElement);
            
            if (data.status === 'success') {
                // Show success message
                const resultHtml = `
                    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
                        <div class="card p-4">
                            <div class="d-flex flex-column align-items-center">
                                <div class="text-success mb-3">
                                    <i class="bi bi-check-circle-fill" style="font-size: 3rem;"></i>
                                </div>
                                <h5>Processed ${data.processed_count} Signals</h5>
                                <p class="text-center text-muted">${testMode ? 'Test mode was enabled, no actual trades were placed.' : 'Trades were placed on Alpaca.'}</p>
                                <button class="btn btn-primary mt-2" id="closeResultBtn">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', resultHtml);
                const resultElement = document.body.lastElementChild;
                
                document.getElementById('closeResultBtn').addEventListener('click', function() {
                    document.body.removeChild(resultElement);
                    
                    // Refresh data
                    fetchPositions();
                    fetchSignals();
                });
            } else {
                console.error('Error processing signals:', data.message);
                
                // Show error message
                const errorHtml = `
                    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
                        <div class="card p-4">
                            <div class="d-flex flex-column align-items-center">
                                <div class="text-danger mb-3">
                                    <i class="bi bi-exclamation-circle-fill" style="font-size: 3rem;"></i>
                                </div>
                                <h5>Error Processing Signals</h5>
                                <p class="text-center text-muted">${data.message}</p>
                                <button class="btn btn-primary mt-2" id="closeErrorBtn">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', errorHtml);
                const errorElement = document.body.lastElementChild;
                
                document.getElementById('closeErrorBtn').addEventListener('click', function() {
                    document.body.removeChild(errorElement);
                });
            }
        })
        .catch(error => {
            // Remove loading state
            document.body.removeChild(loadingElement);
            
            console.error('Error:', error);
            
            // Show error message
            const errorHtml = `
                <div class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
                    <div class="card p-4">
                        <div class="d-flex flex-column align-items-center">
                            <div class="text-danger mb-3">
                                <i class="bi bi-exclamation-circle-fill" style="font-size: 3rem;"></i>
                            </div>
                            <h5>Error Processing Signals</h5>
                            <p class="text-center text-muted">An unexpected error occurred.</p>
                            <button class="btn btn-primary mt-2" id="closeErrorBtn">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', errorHtml);
            const errorElement = document.body.lastElementChild;
            
            document.getElementById('closeErrorBtn').addEventListener('click', function() {
                document.body.removeChild(errorElement);
            });
        });
    }
    
    function processSingleSignal(signalId, testMode) {
        // Show loading state
        const loadingHtml = `
            <div class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
                <div class="card p-4">
                    <div class="d-flex flex-column align-items-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h5>Processing Signal #${signalId}...</h5>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', loadingHtml);
        const loadingElement = document.body.lastElementChild;
        
        // Process the signal
        fetch(`/api/v1/trading/signals/process/${signalId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                test_mode: testMode
            })
        })
        .then(response => response.json())
        .then(data => {
            // Remove loading state
            document.body.removeChild(loadingElement);
            
            if (data.status === 'success') {
                // Show success message
                const resultHtml = `
                    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
                        <div class="card p-4">
                            <div class="d-flex flex-column align-items-center">
                                <div class="text-success mb-3">
                                    <i class="bi bi-check-circle-fill" style="font-size: 3rem;"></i>
                                </div>
                                <h5>Signal Processed Successfully</h5>
                                <p class="text-center text-muted">${data.result.message}</p>
                                <button class="btn btn-primary mt-2" id="closeResultBtn">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', resultHtml);
                const resultElement = document.body.lastElementChild;
                
                document.getElementById('closeResultBtn').addEventListener('click', function() {
                    document.body.removeChild(resultElement);
                    
                    // Refresh data
                    fetchPositions();
                    fetchSignals();
                });
            } else {
                console.error('Error processing signal:', data.message);
                
                // Show error message
                const errorHtml = `
                    <div class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
                        <div class="card p-4">
                            <div class="d-flex flex-column align-items-center">
                                <div class="text-danger mb-3">
                                    <i class="bi bi-exclamation-circle-fill" style="font-size: 3rem;"></i>
                                </div>
                                <h5>Error Processing Signal</h5>
                                <p class="text-center text-muted">${data.message}</p>
                                <button class="btn btn-primary mt-2" id="closeErrorBtn">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', errorHtml);
                const errorElement = document.body.lastElementChild;
                
                document.getElementById('closeErrorBtn').addEventListener('click', function() {
                    document.body.removeChild(errorElement);
                });
            }
        })
        .catch(error => {
            // Remove loading state
            document.body.removeChild(loadingElement);
            
            console.error('Error:', error);
            
            // Show error message
            const errorHtml = `
                <div class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background-color: rgba(0,0,0,0.5); z-index: 9999;">
                    <div class="card p-4">
                        <div class="d-flex flex-column align-items-center">
                            <div class="text-danger mb-3">
                                <i class="bi bi-exclamation-circle-fill" style="font-size: 3rem;"></i>
                            </div>
                            <h5>Error Processing Signal</h5>
                            <p class="text-center text-muted">An unexpected error occurred.</p>
                            <button class="btn btn-primary mt-2" id="closeErrorBtn">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', errorHtml);
            const errorElement = document.body.lastElementChild;
            
            document.getElementById('closeErrorBtn').addEventListener('click', function() {
                document.body.removeChild(errorElement);
            });
        });
    }
</script>
{% endblock %}