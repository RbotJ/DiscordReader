name: Template CI

on:
  push:
    branches: [ main ]
    paths: 
      - 'templates/**/*.html'
      - 'scripts/validate_templates.py'
      - 'scripts/generate_template_registry.py'
  pull_request:
    branches: [ main ]
    paths:
      - 'templates/**/*.html'
      - 'scripts/validate_templates.py'
      - 'scripts/generate_template_registry.py'

jobs:
  validate-templates:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest
        npm install -g htmlhint prettier
        
    - name: Lint HTML templates
      run: |
        echo "üîç Running HTML linting..."
        htmlhint "templates/**/*.html"
        
    - name: Validate templates
      run: |
        echo "üîç Running template validation..."
        python scripts/validate_templates.py
        
    - name: Run template tests
      run: |
        echo "üß™ Running template pytest suite..."
        python -m pytest tests/test_templates.py -v
        
    - name: Generate template registry
      run: |
        echo "üìù Generating template registry..."
        python scripts/generate_template_registry.py
        
    - name: Check for registry changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit updated registry
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add templates/README.md
        git commit -m "ü§ñ Auto-update template registry" || exit 0
        
    - name: Push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}

  template-audit:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Run template audit
      run: |
        if [ -f "scripts/template_audit.py" ]; then
          echo "üìä Running template audit..."
          python scripts/template_audit.py
        else
          echo "‚ÑπÔ∏è Template audit script not found, skipping"
        fi
        
    - name: Comment audit results
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          try {
            // Try to read audit results
            let auditContent = '';
            if (fs.existsSync('template_audit.md')) {
              auditContent = fs.readFileSync('template_audit.md', 'utf8');
            } else {
              auditContent = '‚úÖ Template audit completed - no detailed report generated.';
            }
            
            const comment = `## üìä Template Audit Results
            
            ${auditContent}
            
            ---
            *This comment was automatically generated by the Template CI workflow.*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('Could not post audit results:', error);
          }